!function(){"use strict";let e={ws:void 0,auth:void 0,urls:{ws:"/_tattler/ws",channels:"/_tattler/channels",auth:"/_tattler/auth"},requests:{ws:"get",channels:"get",auth:"get"},readyCallback:!1,readyCallbackOnce:!1,autoConnect:!0,debug:!1},n={};const t=function(){let e="GET",n="POST";const t=function(e,n){let o,s=[];for(o in e)if(e.hasOwnProperty(o)){let r=n?n+"["+o+"]":o,a=e[o];s.push(null!==a&&"object"==typeof a?t(a,r):encodeURIComponent(r)+"="+encodeURIComponent(a))}return s.join("&")};this._request=function(e,n,o){let s={success:[],fail:[],complete:[]};const r=function(){this._xmlhttp=new XMLHttpRequest,this._xmlhttp.onreadystatechange=this._onReadyStateChange;let s="";if("GET"===e){let e="?";n.match(/\?/)&&(e="&"),n+=e+t(s),s=""}else s=JSON.stringify(o);return this._xmlhttp.open(e,n,!0),this._xmlhttp.setRequestHeader("X-Requested-With","XMLHttpRequest"),this._xmlhttp.send(s)};return r.prototype._onReadyStateChange=function(){if(this._xmlhttp.readyState===XMLHttpRequest.DONE)if(this._xmlhttp.status>=200&&this._xmlhttp.status<300){let e;try{e=JSON.parse(this._xmlhttp.responseText)}catch(n){e=this._xmlhttp.responseText}for(let n in s.success)s[n](e);for(let e in s.complete)s[e](!0)}else{let e=this._xmlhttp.response;for(let n in s.fail)s[n](e);for(let e in s.complete)s[e](!1)}},r.onDone=function(e){s.success.push(e)},r.onFail=function(e){s.fail.push(e)},r.onComplete=function(e){s.complete.push(e)},new r(e,n,o)},this.get=function(n,t){return this._request(e,n,t)},this.post=function(e,t){return this._request(n,e,t)}},o={getInstance:function(e){return n[e]},create:function(e){let t=new s(e);return n[function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}()]=t,t}},s=function(n){let o=[];const s=function(e,n){let t=e;for(let e in n)n.hasOwnProperty(e)&&(t[e]=n[e]);return t}(e,n);let r=!1;const a={getWs:{onSuccess:function(e){c.server=e.ws,y()},onError:function(){p("error","Failed to get ws address")}},getChannels:{onSuccess:function(e){for(let n in e.channels)e.channels.hasOwnProperty(n)&&d(e.channels[n],!0,!0);a.socket.handleEvents(),"function"==typeof s.readyCallback&&s.readyCallback(),"function"==typeof s.readyCallbackOnce&&(s.readyCallbackOnce(),s.readyCallbackOnce=!1)},onError:function(){p("error","Failed to get channels listing")}},socket:{connected:function(){m(),p("warn","connected to socket")},disconnected:function(){p("warn","disconnected from socket");for(let e in c.channels)c.channels.hasOwnProperty(e)&&(c.channels[e]=!1)},handleEvents:function(){void 0===c.socket._callbacks.$defaultEvent&&c.socket.on("defaultEvent",(function(e){let n=e.id||Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,30),t=e.handler,s=e.namespace||"global";for(let t=0;t<10&&o.hasOwnProperty(t);t++)if(o[t]===n)return void p("info","preventing duplicate message processing",e);if(o.unshift(n),o.length=10,!1===i(s,t))p("error","handler "+t+" with namespace "+s+" not defined",e);else for(let n=0;n<c.handlers[s][t].length;n++)void 0===e.payload?c.handlers[s][t][n](e):c.handlers[s][t][n](e.payload)}))}}},c={socket:null,server:null,port:null,channels:{},handlers:{global:{"console.log":[function(e){void 0===e.force?!0===s.debug?(p("warn","-------------------------------------------------------------"),p("warn","remote: "+e.message),p("warn","-------------------------------------------------------------")):p("warn","remote",e.message):console.warn(e)}],alert:[function(e){let n;void 0!==e.title&&(n=e.title),""!==n&&(n="--------------------------"+n.toUpperCase()+"--------------------------",n+="\n"),n+=e.message,alert(n)}],confirm:[function(e){confirm(e.message)?void 0!==e.yes&&"function"==typeof e.yes&&e.yes():void 0!==e.no&&"function"==typeof e.no&&window[e.no]()}],addChannel:[function(e){d(e.channel,!1)}],removeChannel:[function(e){f(e.channel)}]}}};let l=[];const i=function(e,n){return void 0!==c.handlers[e]&&void 0!==c.handlers[e][n]},u=function(){return r||new t},h=function(e,n){c.socket.emit("subscribe",e),void 0===n&&(c.channels[e]=!0)},d=function(e,n,t){void 0===c.channels[e]||c.channels[e]!==n?(c.channels[e]=n,null!==c.socket?(p("info","joining channel «"+e+"»"),"boolean"==typeof t&&!0===t?h(e,n):u()[s.requests.channels](s.urls.channels,{socketId:c.socket.id,channels:[e]}).onDone((function(e){for(let t in e.channels)e.channels.hasOwnProperty(t)&&h(e.channels[t],n)})).onFail(a.getChannels.onError)):p("info","adding channel «"+e+"»")):p("error","channel «"+e+"» already defined")},f=function(e){void 0===c.channels[e]?p("error","failed to unsubscribe from «"+e+"» - channel not defined"):(delete c.channels[e],c.socket.emit("unsubscribe",e),p("warn","unsubscribed from «"+e+"»"))},p=function(){let e=[],n={};for(let n=0;n<arguments.length;n++)e.push(arguments[n]);let t=e.shift();if(n.type=t,n.date=new Date,n.data=e,l.push(n),!0===s.debug){e.unshift("Tattler:");for(let n in e)if("object"==typeof e[n])return void console[t](e);window.console[t](e.join(" "))}},g=function(){void 0!==n.ws?(c.server=n.ws,p("info","using WS url "+n.ws),y()):(p("info","requesting WS url"),u()[s.requests.ws](s.urls.ws,{}).onDone(a.getWs.onSuccess).onFail(a.getWs.onError))},y=function(){if(null===c.socket){if(null===c.server)return void p("error","Failed to connect to socket: address unknown");e=function(e){c.socket=io(c.server,{query:"token="+e}),c.socket.on("connect",a.socket.connected),c.socket.on("disconnect",a.socket.disconnected),p("info","connecting to socket at "+c.server)},void 0!==n.auth?e(n.auth):u()[s.requests.auth](s.urls.auth,{}).onDone((function(n){e(n.token)})).onFail(t)}else p("error","socket already connected");var e,t},m=function(){let e=c.socket.id,n=[];if(function(e){for(let n in e)if(e.hasOwnProperty(n))return!1;return JSON.stringify(e)===JSON.stringify({})}(c.channels))p("log","requesting channels with socketId="+e);else{p("log","connecting to saved channels");for(let e in c.channels)c.channels.hasOwnProperty(e)&&n.push(e)}u()[s.requests.channels](s.urls.channels,{socketId:e,channels:n}).onDone(a.getChannels.onSuccess).onFail(a.getChannels.onError)};s.autoConnect&&g(),p("info","creating socket's stuff..."),this.setAjaxImplementer=function(e){r=e},this.debug=function(){for(let e in l)console[l[e].type](l[e].date,l[e].data)},this.addHandler=function(e,n,t){"function"==typeof n&&(t=n,n="global"),void 0===c.handlers[n]&&(c.handlers[n]={}),void 0===c.handlers[n][e]&&(c.handlers[n][e]=[]),c.handlers[n][e].push(t),p("info","added handler for event «"+e+"» in namespace «"+n+"»")},this.removeHandler=function(e,n){void 0!==c.handlers[n]&&void 0!==c.handlers[n][e]?(p("info","removed handler(s) for event «"+e+"» in namespace «"+n+"»"),delete c.handlers[n][e]):p("warn","failed to remove handler for event «"+e+"» in namespace «"+n+"»: handler not found")},this.addChannel=d,this.removeChannel=f,this.run=g,this.disconnect=function(){null!==c.socket&&(c.socket.disconnect(),c.socket=null)}};window.TattlerFactory=o,window.tattlerFactory={getInstance:function(e){return console.warn("tattlerFactory is deprecated, use TattlerFactory"),o.getInstance(e)},create:function(e){return console.warn("tattlerFactory is deprecated, use TattlerFactory"),o.create(e)}}}();
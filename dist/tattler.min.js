!function(){"use strict";function n(n,e){var t=n;for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);return t}function e(){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function t(n,e,t,o,r,a){var s=function(n,e){var t,o=[];for(t in n)if(n.hasOwnProperty(t)){var r=e?e+"["+t+"]":t,a=n[t];o.push(null!==a&&"object"==typeof a?s(a,r):encodeURIComponent(r)+"="+encodeURIComponent(a))}return o.join("&")},c=new XMLHttpRequest;if(c.onreadystatechange=function(){c.readyState===XMLHttpRequest.DONE&&(c.status>=200&&c.status<300?("function"==typeof o&&o(JSON.parse(c.responseText)),"function"==typeof a&&a(!0)):("function"==typeof r&&r(c.response),"function"==typeof a&&a(!1)))},"GET"===(n=n.toUpperCase())){var i="?";e.match(/\?/)&&(i="&"),e+=i+s(t),t=""}else t=JSON.stringify(t);return c.open(n,e,!0),c.setRequestHeader("X-Requested-With","XMLHttpRequest"),c.send(t)}function o(n){for(var e in n)if(n.hasOwnProperty(e))return!1;return JSON.stringify(n)===JSON.stringify({})}var r={ws:void 0,auth:void 0,urls:{ws:"/_tattler/ws",channels:"/_tattler/channels",auth:"/_tattler/auth"},requests:{ws:"get",channels:"get",auth:"get"},readyCallback:!1,readyCallbackOnce:!1,autoConnect:!0,debug:!1},a={},s={getInstance:function(n){return a[n]},create:function(n){var t=new c(n);return a[e()]=t,t}},c=function(e){var a=[],s=n(r,e),c={getWs:{onSuccess:function(n){i.server=n.ws,m()},onError:function(){g("error","Failed to get ws address")}},getChannels:{onSuccess:function(n){for(var e in n.channels)n.channels.hasOwnProperty(e)&&f(n.channels[e],!0,!0);c.socket.handleEvents(),"function"==typeof s.readyCallback&&s.readyCallback(),"function"==typeof s.readyCallbackOnce&&(s.readyCallbackOnce(),s.readyCallbackOnce=!1)},onError:function(){g("error","Failed to get channels listing")}},socket:{connected:function(){b(),g("warn","connected to socket")},disconnected:function(){g("error","disconnected from socket");for(var n in i.channels)i.channels.hasOwnProperty(n)&&(i.channels[n]=!1)},handleEvents:function(){void 0===i.socket._callbacks.$defaultEvent&&i.socket.on("defaultEvent",function(n){for(var e=n.id||Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,30),t=n.handler,o=n.namespace||"global",r=0;r<10&&a.hasOwnProperty(r);r++)if(a[r]===e)return void g("info","preventing duplicate message processing",n);if(a.unshift(e),a.length=10,!1===u(o,t))g("error","handler "+t+" with namespace "+o+" not defined",n);else for(var s=0;s<i.handlers[o][t].length;s++)void 0===n.payload?i.handlers[o][t][s](n):i.handlers[o][t][s](n.payload)})}}},i={socket:null,server:null,port:null,channels:{},handlers:{global:{"console.log":[function(n){if(void 0!==n.force)return void console.warn(n);!0===s.debug?(g("warn","-------------------------------------------------------------"),g("warn","remote: "+n.message),g("warn","-------------------------------------------------------------")):g("warn","remote",n.message)}],alert:[function(n){var e;void 0!==n.title&&(e=n.title),""!==e&&(e="--------------------------"+e.toUpperCase()+"--------------------------",e+="\n"),e+=n.message,alert(e)}],confirm:[function(n){confirm(n.message)?void 0!==n.yes&&"function"==typeof n.yes&&n.yes():void 0!==n.no&&"function"==typeof n.no&&window[n.no]()}],addChannel:[function(n){f(n.channel,!1)}],removeChannel:[function(n){h(n.channel)}]}}},l=[],u=function(n,e){return void 0!==i.handlers[n]&&void 0!==i.handlers[n][e]},d=function(n,e){i.socket.emit("subscribe",n),void 0===e&&(i.channels[n]=!0)},f=function(n,e,o){void 0===i.channels[n]||i.channels[n]!==e?(i.channels[n]=e,null!==i.socket?(g("info","joining channel «"+n+"»"),"boolean"==typeof o&&!0===o?d(n,e):t(s.requests.channels,s.urls.channels,{socketId:i.socket.id,channels:[n]},function(n){for(var t in n.channels)n.channels.hasOwnProperty(t)&&d(n.channels[t],e)},c.getChannels.onError)):g("info","adding channel «"+n+"»")):g("error","channel «"+n+"» already defined")},h=function(n){void 0===i.channels[n]?g("error","failed to unsubscribe from «"+n+"» - channel not defined"):(delete i.channels[n],i.socket.emit("unsubscribe",n),g("warn","unsubscribed from «"+n+"»"))},v=function(n,e,t){"function"==typeof e&&(t=e,e="global"),void 0===i.handlers[e]&&(i.handlers[e]={}),void 0===i.handlers[e][n]&&(i.handlers[e][n]=[]),i.handlers[e][n].push(t),g("info","added handler for event «"+n+"» in namespace «"+e+"»")},p=function(n,e){void 0!==i.handlers[e]&&void 0!==i.handlers[e][n]?(g("info","removed handler(s) for event «"+n+"» in namespace «"+e+"»"),delete i.handlers[e][n]):g("warn","failed to remove handler for event «"+n+"» in namespace «"+e+"»: handler not found")},g=function(){for(var n=[],e={},t=0;t<arguments.length;t++)n.push(arguments[t]);var o=n.shift();if(e.type=o,e.date=new Date,e.data=n,l.push(e),!0===s.debug){n.unshift("Tattler:");for(var r in n)if("object"==typeof n[r])return void console[o](n);window.console[o](n.join(" "))}},y=function(){for(var n in l)console[l[n].type](l[n].date,l[n].data)},w=function(){void 0!==e.ws?(i.server=e.ws,g("info","using WS url "+e.ws),m()):(g("info","requesting WS url"),t(s.requests.ws,s.urls.ws,{},c.getWs.onSuccess,c.getWs.onError))},k=function(n,o){void 0!==e.auth?n(e.auth):t(s.requests.auth,s.urls.auth,{},function(e){n(e.token)},o)},m=function(){if(null===i.socket){if(null===i.server)return void g("error","Failed to connect to socket: address unknown");k(function(n){i.socket=io(i.server,{query:"token="+n}),i.socket.on("connect",c.socket.connected),i.socket.on("disconnect",c.socket.disconnected),g("info","connecting to socket at "+i.server)})}else g("error","socket already connected")},b=function(){var n=i.socket.io.engine.id,e=[];if(o(i.channels))g("log","requesting channels with socketId="+n);else{g("log","connecting to saved channels");for(var r in i.channels)i.channels.hasOwnProperty(r)&&e.push(r)}t(s.requests.channels,s.urls.channels,{socketId:n,channels:e},c.getChannels.onSuccess,c.getChannels.onError)};s.autoConnect&&w(),g("info","creating socket's stuff..."),this.debug=y,this.addHandler=v,this.removeHandler=p,this.addChannel=f,this.removeChannel=h,this.run=w};window.TattlerFactory=s,window.tattlerFactory={getInstance:function(n){return console.warn("tattlerFactory is deprecated, use TattlerFactory"),s.getInstance(n)},create:function(n){return console.warn("tattlerFactory is deprecated, use TattlerFactory"),s.create(n)}}}();
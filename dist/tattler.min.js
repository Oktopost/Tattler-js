!function(){"use strict";function e(e,n){var t=e;for(var o in n)n.hasOwnProperty(o)&&(t[o]=n[o]);return t}function n(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function t(e){for(var n in e)if(e.hasOwnProperty(n))return!1;return JSON.stringify(e)===JSON.stringify({})}var o={ws:void 0,auth:void 0,urls:{ws:"/_tattler/ws",channels:"/_tattler/channels",auth:"/_tattler/auth"},requests:{ws:"get",channels:"get",auth:"get"},readyCallback:!1,readyCallbackOnce:!1,autoConnect:!0,debug:!1},s={},r=function(){this._methods={get:"GET",post:"POST"},this.prototype._serialize=function(e,n){var t,o=[];for(t in e)if(e.hasOwnProperty(t)){var s=n?n+"["+t+"]":t,r=e[t];o.push(null!==r&&"object"==typeof r?serialize(r,s):encodeURIComponent(s)+"="+encodeURIComponent(r))}return o.join("&")},this.prototype._request=function(e,n,t){var o=function(){classify(this),this._response={},this._isSuccess=!1,this._callbacks={success:[],fail:[],complete:[]},this._xmlhttp=new XMLHttpRequest,this._xmlhttp.onreadystatechange=this._onReadyStateChange;var o="";if("GET"===e){var s="?";n.match(/\?/)&&(s="&"),n+=s+this._serialize(o),o=""}else o=JSON.stringify(t);return this._xmlhttp.open(e,n,!0),this._xmlhttp.setRequestHeader("X-Requested-With","XMLHttpRequest"),this._xmlhttp.send(o)};return o.prototype._onReadyStateChange=function(){if(this._xmlhttp.readyState===XMLHttpRequest.DONE)if(this._xmlhttp.status>=200&&this._xmlhttp.status<300){var e;try{e=JSON.parse(this._xmlhttp.responseText)}catch(n){e=this._xmlhttp.responseText}foreach(this._callbacks.success,this,function(n){n(e)}),foreach(this._callbacks.complete,this,function(e){e(!0)})}else{var n=this._xmlhttp.response;foreach(this._callbacks.fail,this,function(e){e(n)}),foreach(this._callbacks.complete,this,function(e){e(!1)})}},o.prototype.onDone=function(e){this._callbacks.success.push(e)},o.prototype.onFail=function(e){this._callbacks.fail.push(e)},o.prototype.onComplete=function(e){this._callbacks.complete.push(e)},new o(e,n,t)},this.prototype.get=function(e,n){return this._request(this._methods.get,e,n)},this.prototype.post=function(e,n){return this._request(this._methods.post,e,n)}},a={getInstance:function(e){return s[e]},create:function(e){var t=new c(e);return s[n()]=t,t}},c=function(n){var s=[],a=e(o,n),c=!1,i={getWs:{onSuccess:function(e){l.server=e.ws,C()},onError:function(){m("error","Failed to get ws address")}},getChannels:{onSuccess:function(e){for(var n in e.channels)e.channels.hasOwnProperty(n)&&p(e.channels[n],!0,!0);i.socket.handleEvents(),"function"==typeof a.readyCallback&&a.readyCallback(),"function"==typeof a.readyCallbackOnce&&(a.readyCallbackOnce(),a.readyCallbackOnce=!1)},onError:function(){m("error","Failed to get channels listing")}},socket:{connected:function(){O(),m("warn","connected to socket")},disconnected:function(){m("error","disconnected from socket");for(var e in l.channels)l.channels.hasOwnProperty(e)&&(l.channels[e]=!1)},handleEvents:function(){void 0===l.socket._callbacks.$defaultEvent&&l.socket.on("defaultEvent",function(e){for(var n=e.id||Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,30),t=e.handler,o=e.namespace||"global",r=0;r<10&&s.hasOwnProperty(r);r++)if(s[r]===n)return void m("info","preventing duplicate message processing",e);if(s.unshift(n),s.length=10,!1===u(o,t))m("error","handler "+t+" with namespace "+o+" not defined",e);else for(var a=0;a<l.handlers[o][t].length;a++)void 0===e.payload?l.handlers[o][t][a](e):l.handlers[o][t][a](e.payload)})}}},l={socket:null,server:null,port:null,channels:{},handlers:{global:{"console.log":[function(e){if(void 0!==e.force)return void console.warn(e);!0===a.debug?(m("warn","-------------------------------------------------------------"),m("warn","remote: "+e.message),m("warn","-------------------------------------------------------------")):m("warn","remote",e.message)}],alert:[function(e){var n;void 0!==e.title&&(n=e.title),""!==n&&(n="--------------------------"+n.toUpperCase()+"--------------------------",n+="\n"),n+=e.message,alert(n)}],confirm:[function(e){confirm(e.message)?void 0!==e.yes&&"function"==typeof e.yes&&e.yes():void 0!==e.no&&"function"==typeof e.no&&window[e.no]()}],addChannel:[function(e){p(e.channel,!1)}],removeChannel:[function(e){v(e.channel)}]}}},h=[],u=function(e,n){return void 0!==l.handlers[e]&&void 0!==l.handlers[e][n]},d=function(){return c||new r},f=function(e,n){l.socket.emit("subscribe",e),void 0===n&&(l.channels[e]=!0)},p=function(e,n,t){void 0===l.channels[e]||l.channels[e]!==n?(l.channels[e]=n,null!==l.socket?(m("info","joining channel «"+e+"»"),"boolean"==typeof t&&!0===t?f(e,n):(d()[a.requests.channels](a.urls.channels),{socketId:l.socket.id,channels:[e]}.onDone(function(e){for(var t in e.channels)e.channels.hasOwnProperty(t)&&f(e.channels[t],n)}).onFail(i.getChannels.onError))):m("info","adding channel «"+e+"»")):m("error","channel «"+e+"» already defined")},v=function(e){void 0===l.channels[e]?m("error","failed to unsubscribe from «"+e+"» - channel not defined"):(delete l.channels[e],l.socket.emit("unsubscribe",e),m("warn","unsubscribed from «"+e+"»"))},g=function(e,n,t){"function"==typeof n&&(t=n,n="global"),void 0===l.handlers[n]&&(l.handlers[n]={}),void 0===l.handlers[n][e]&&(l.handlers[n][e]=[]),l.handlers[n][e].push(t),m("info","added handler for event «"+e+"» in namespace «"+n+"»")},y=function(e,n){void 0!==l.handlers[n]&&void 0!==l.handlers[n][e]?(m("info","removed handler(s) for event «"+e+"» in namespace «"+n+"»"),delete l.handlers[n][e]):m("warn","failed to remove handler for event «"+e+"» in namespace «"+n+"»: handler not found")},m=function(){for(var e=[],n={},t=0;t<arguments.length;t++)e.push(arguments[t]);var o=e.shift();if(n.type=o,n.date=new Date,n.data=e,h.push(n),!0===a.debug){e.unshift("Tattler:");for(var s in e)if("object"==typeof e[s])return void console[o](e);window.console[o](e.join(" "))}},w=function(e){c=e},k=function(){for(var e in h)console[h[e].type](h[e].date,h[e].data)},b=function(){void 0!==n.ws?(l.server=n.ws,m("info","using WS url "+n.ws),C()):(m("info","requesting WS url"),d()[a.requests.ws](a.urls.ws,{}).onDone(i.getWs.onSuccess).onFail(i.getWs.onError))},_=function(e,t){void 0!==n.auth?e(n.auth):d()[a.requests.auth](a.urls.auth,{}).onDone(function(n){e(n.token)}).onFail(t)},C=function(){if(null===l.socket){if(null===l.server)return void m("error","Failed to connect to socket: address unknown");_(function(e){l.socket=io(l.server,{query:"token="+e}),l.socket.on("connect",i.socket.connected),l.socket.on("disconnect",i.socket.disconnected),m("info","connecting to socket at "+l.server)})}else m("error","socket already connected")},O=function(){var e=l.socket.io.engine.id,n=[];if(t(l.channels))m("log","requesting channels with socketId="+e);else{m("log","connecting to saved channels");for(var o in l.channels)l.channels.hasOwnProperty(o)&&n.push(o)}d()[a.requests.channels](a.urls.channels,{socketId:e,channels:n}).onDone(i.getChannels.onSuccess).onFail(i.getChannels.onError)};a.autoConnect&&b(),m("info","creating socket's stuff..."),this.setAjaxImplementer=w,this.debug=k,this.addHandler=g,this.removeHandler=y,this.addChannel=p,this.removeChannel=v,this.run=b};window.TattlerFactory=a,window.tattlerFactory={getInstance:function(e){return console.warn("tattlerFactory is deprecated, use TattlerFactory"),a.getInstance(e)},create:function(e){return console.warn("tattlerFactory is deprecated, use TattlerFactory"),a.create(e)}}}();